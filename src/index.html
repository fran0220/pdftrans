<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF å¤šè¯­è¨€ç¿»è¯‘å™¨</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        .main-container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        /* Upload area */
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .upload-area:hover { border-color: #007bff; }
        .upload-area.dragover { border-color: #007bff; background: #f8f9ff; }
        .upload-area input { display: none; }
        .upload-icon { font-size: 40px; margin-bottom: 10px; }
        .upload-text { color: #666; font-size: 14px; }
        
        /* Progress section */
        .progress-section {
            display: none;
            margin-top: 20px;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .progress-title { font-weight: 500; color: #333; }
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #00c6ff);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }
        .progress-detail {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #333;
        }
        
        /* Log panel */
        .log-panel { margin-top: 15px; }
        .log-panel summary {
            cursor: pointer;
            font-size: 13px;
            color: #666;
        }
        .log-content {
            margin-top: 10px;
            max-height: 120px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            font-size: 11px;
            font-family: monospace;
        }
        .log-entry { padding: 2px 0; color: #555; }
        
        /* Buttons */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-cancel:hover { background: #c82333; }
        .btn-download { background: #28a745; color: white; display: none; }
        .btn-download:hover { background: #218838; }
        .btn-retry { background: #fd7e14; color: white; display: none; }
        .btn-retry:hover { background: #e67e22; }
        
        .status {
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }

        /* Log Drawer */
        .log-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 999;
        }
        .log-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .log-drawer {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 340px;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .log-drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        .drawer-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }
        .drawer-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }
        .drawer-close:hover { color: #333; }
        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .drawer-section {
            margin-bottom: 20px;
        }
        .drawer-section h4 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Page Cards */
        .page-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .page-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .page-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        .page-card-header .page-num {
            font-weight: 600;
            color: #333;
        }
        .page-card-body {
            padding: 12px;
        }
        .page-card-section {
            margin-bottom: 10px;
        }
        .page-card-section:last-child {
            margin-bottom: 0;
        }
        .page-card-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        .page-card-label .stats {
            color: #999;
        }
        .page-card-content {
            font-size: 12px;
            color: #333;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            max-height: 80px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.4;
            cursor: pointer;
            transition: max-height 0.3s ease;
            overscroll-behavior: contain;
        }
        .page-card-content:hover {
            background: #e9ecef;
        }
        .page-card-content.expanded {
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .page-card-content.empty {
            color: #999;
            font-style: italic;
            cursor: default;
        }
        .page-card-content.loading {
            color: #666;
            font-style: italic;
        }
        .expand-hint {
            font-size: 10px;
            color: #999;
            margin-left: 8px;
        }
        .page-card-error {
            color: #dc3545;
            font-size: 12px;
            padding: 8px;
            background: #f8d7da;
            border-radius: 4px;
        }
        .page-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .page-status.pending { background: #e9ecef; color: #666; }
        .page-status.ocr { background: #fff3cd; color: #856404; }
        .page-status.translating { background: #cce5ff; color: #004085; }
        .page-status.done { background: #d4edda; color: #155724; }
        .page-status.error { background: #f8d7da; color: #721c24; }

        /* Drawer Log List */
        .drawer-log-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
        }
        .drawer-log-entry {
            padding: 3px 0;
            font-size: 11px;
            font-family: monospace;
            color: #555;
            border-bottom: 1px solid #eee;
        }
        .drawer-log-entry:last-child { border-bottom: none; }

        /* Log Button */
        .btn-log {
            background: #6c757d;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-log:hover { background: #5a6268; }

        @media (max-width: 600px) {
            .log-drawer { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>ğŸ“„ PDF å¤šè¯­è¨€ç¿»è¯‘å™¨</h1>
        <p class="subtitle">æ”¯æŒè‹±æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ç­‰ â†’ ä¸­æ–‡ | å¹¶è¡Œå¤„ç†</p>
        
        <!-- Main container -->
        <div class="container">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  PDF æ–‡ä»¶ï¼ˆæœ€å¤š 3 ä¸ªä»»åŠ¡å¹¶è¡Œï¼‰</div>
                <input type="file" id="fileInput" accept=".pdf">
            </div>
            
            <div class="progress-section" id="progressSection">
                <div class="progress-header">
                    <span class="progress-title" id="progressTitle">å¤„ç†ä¸­...</span>
                    <span>
                        <button class="btn-log" id="logBtn" title="æŸ¥çœ‹è¯¦ç»†æ—¥å¿—">ğŸ“‹</button>
                        <span id="progressPercent">0%</span>
                    </span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-stats">
                    <span>OCR: <span id="ocrProgress">0/0</span></span>
                    <span>ç¿»è¯‘: <span id="translateProgress">0/0</span></span>
                </div>
                <div class="progress-detail" id="progressDetail"></div>
                
                <details class="log-panel">
                    <summary>å¤„ç†æ—¥å¿—</summary>
                    <div class="log-content" id="logContent"></div>
                </details>
                
                <div class="status" id="status"></div>
                
                <div class="btn-row">
                    <button class="btn btn-cancel" id="cancelBtn">å–æ¶ˆ</button>
                    <button class="btn btn-retry" id="retryBtn">é‡è¯•</button>
                    <button class="btn btn-download" id="downloadBtn">ä¸‹è½½ PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Drawer Overlay -->
    <div class="log-overlay" id="logOverlay"></div>
    
    <!-- Log Drawer -->
    <div class="log-drawer" id="logDrawer">
        <div class="drawer-header">
            <h3>ğŸ“‹ å¤„ç†è¯¦æƒ…</h3>
            <button class="drawer-close" id="drawerClose">&times;</button>
        </div>
        <div class="drawer-body">
            <div class="drawer-section">
                <h4>é¡µé¢å¤„ç†çŠ¶æ€</h4>
                <div class="page-cards" id="pageCardsContainer"></div>
            </div>
            <div class="drawer-section">
                <h4>ç³»ç»Ÿæ—¥å¿—</h4>
                <div class="drawer-log-list" id="drawerLogList"></div>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');
        const progressTitle = document.getElementById('progressTitle');
        const progressDetail = document.getElementById('progressDetail');
        const ocrProgress = document.getElementById('ocrProgress');
        const translateProgress = document.getElementById('translateProgress');
        const logContent = document.getElementById('logContent');
        const status = document.getElementById('status');
        const cancelBtn = document.getElementById('cancelBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const logBtn = document.getElementById('logBtn');
        const retryBtn = document.getElementById('retryBtn');
        const logOverlay = document.getElementById('logOverlay');
        const logDrawer = document.getElementById('logDrawer');
        const drawerClose = document.getElementById('drawerClose');
        const pageCardsContainer = document.getElementById('pageCardsContainer');
        const drawerLogList = document.getElementById('drawerLogList');
        
        let currentTaskId = null;
        let currentEventSource = null;
        let connectAttempt = 0;
        let reconnectTimer = null;
        let isManuallyClosed = false;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // Event listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        cancelBtn.addEventListener('click', async () => {
            if (currentTaskId) {
                isManuallyClosed = true;
                clearReconnectTimer();
                if (currentEventSource) {
                    currentEventSource.close();
                    currentEventSource = null;
                }
                cancelBtn.disabled = true;
                try {
                    await fetch(`/cancel/${currentTaskId}`, { method: 'POST' });
                    status.textContent = 'å·²å–æ¶ˆ';
                    status.className = 'status';
                    cancelBtn.style.display = 'none';
                    retryBtn.style.display = 'none';
                } catch (e) {
                    status.textContent = 'å–æ¶ˆå¤±è´¥: ' + e.message;
                    status.className = 'status error';
                }
                cancelBtn.disabled = false;
            }
        });

        retryBtn.addEventListener('click', async () => {
            if (currentTaskId) {
                // ç«‹å³æ›´æ–° UIï¼ˆä¹è§‚æ›´æ–°ï¼‰
                retryBtn.disabled = true;
                retryBtn.style.display = 'none';
                cancelBtn.style.display = 'block';
                status.textContent = 'æ­£åœ¨é‡è¯•...';
                status.className = 'status';
                progressDetail.textContent = 'å‡†å¤‡é‡æ–°å¤„ç†...';
                
                try {
                    const response = await fetch(`/retry/${currentTaskId}`, { method: 'POST' });
                    if (response.ok) {
                        // é‡ç½®çŠ¶æ€å¹¶ç›‘å¬è¿›åº¦
                        isManuallyClosed = false;
                        connectAttempt = 0;
                        pageDetailCache.clear(); // æ¸…é™¤é¡µé¢ç¼“å­˜
                        listenProgress(currentTaskId);
                    } else {
                        const text = await response.text();
                        status.textContent = 'âŒ é‡è¯•å¤±è´¥: ' + text;
                        status.className = 'status error';
                        cancelBtn.style.display = 'none';
                        retryBtn.style.display = 'block';
                    }
                } catch (e) {
                    status.textContent = 'âŒ é‡è¯•å¤±è´¥: ' + e.message;
                    status.className = 'status error';
                    cancelBtn.style.display = 'none';
                    retryBtn.style.display = 'block';
                }
                retryBtn.disabled = false;
            }
        });

        window.addEventListener('online', () => {
            if (currentTaskId && !currentEventSource && !isManuallyClosed) {
                clearReconnectTimer();
                connectAttempt = 0;
                listenProgress(currentTaskId);
            }
        });

        function clearReconnectTimer() {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
        }

        downloadBtn.addEventListener('click', () => {
            if (currentTaskId) {
                window.location.href = `/download/${currentTaskId}`;
            }
        });

        // Drawer functions
        function openDrawer() {
            logOverlay.classList.add('open');
            logDrawer.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            logOverlay.classList.remove('open');
            logDrawer.classList.remove('open');
            document.body.style.overflow = '';
        }

        logBtn.addEventListener('click', openDrawer);
        drawerClose.addEventListener('click', closeDrawer);
        logOverlay.addEventListener('click', closeDrawer);
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && logDrawer.classList.contains('open')) {
                closeDrawer();
            }
        });

        // ç¼“å­˜åŠ è½½çš„å®Œæ•´é¡µé¢å†…å®¹
        const pageDetailCache = new Map();
        
        function renderPageSummaries(summaries) {
            if (!summaries || summaries.length === 0) {
                pageCardsContainer.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const statusLabels = {
                'pending': 'ç­‰å¾…ä¸­',
                'ocr': 'OCR è¯†åˆ«ä¸­',
                'translating': 'ç¿»è¯‘ä¸­',
                'done': 'å·²å®Œæˆ',
                'error': 'å¤±è´¥'
            };
            
            pageCardsContainer.innerHTML = summaries.map(ps => {
                const ocrStats = ps.ocr_duration_ms != null 
                    ? `${ps.ocr_chars || 0} å­— Â· ${ps.ocr_duration_ms}ms`
                    : '';
                const transStats = ps.translate_duration_ms != null 
                    ? `${ps.translated_chars || 0} å­— Â· ${ps.translate_duration_ms}ms`
                    : '';
                
                const hasOcr = ps.ocr_text_preview || ps.status === 'done';
                const hasTrans = ps.translated_text_preview || ps.status === 'done';
                const expandHint = (hasOcr || hasTrans) ? '<span class="expand-hint">ç‚¹å‡»å±•å¼€</span>' : '';
                
                const ocrContent = ps.ocr_text_preview 
                    ? `<div class="page-card-content" data-task="${currentTaskId}" data-page="${ps.page_num}" data-type="ocr">${escapeHtml(ps.ocr_text_preview)}${ps.ocr_chars > 300 ? '...' : ''}</div>`
                    : `<div class="page-card-content empty">${ps.status === 'pending' ? 'ç­‰å¾…å¤„ç†' : ps.status === 'ocr' ? 'è¯†åˆ«ä¸­...' : 'æ— å†…å®¹'}</div>`;
                
                const transContent = ps.translated_text_preview 
                    ? `<div class="page-card-content" data-task="${currentTaskId}" data-page="${ps.page_num}" data-type="trans">${escapeHtml(ps.translated_text_preview)}${ps.translated_chars > 300 ? '...' : ''}</div>`
                    : `<div class="page-card-content empty">${['pending', 'ocr'].includes(ps.status) ? 'ç­‰å¾…ç¿»è¯‘' : ps.status === 'translating' ? 'ç¿»è¯‘ä¸­...' : 'æ— å†…å®¹'}</div>`;
                
                const errorSection = ps.error 
                    ? `<div class="page-card-section"><div class="page-card-error">âŒ ${escapeHtml(ps.error)}</div></div>` 
                    : '';
                
                return `<div class="page-card">
                    <div class="page-card-header">
                        <span class="page-num">ç¬¬ ${ps.page_num} é¡µ</span>
                        <span class="page-status ${ps.status}">${statusLabels[ps.status] || ps.status}</span>
                    </div>
                    <div class="page-card-body">
                        <div class="page-card-section">
                            <div class="page-card-label">
                                <span>ğŸ“– OCR è¯†åˆ«ç»“æœ${expandHint}</span>
                                <span class="stats">${ocrStats}</span>
                            </div>
                            ${ocrContent}
                        </div>
                        <div class="page-card-section">
                            <div class="page-card-label">
                                <span>ğŸŒ ç¿»è¯‘ç»“æœ${expandHint}</span>
                                <span class="stats">${transStats}</span>
                            </div>
                            ${transContent}
                        </div>
                        ${errorSection}
                    </div>
                </div>`;
            }).join('');
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            pageCardsContainer.querySelectorAll('.page-card-content[data-page]').forEach(el => {
                el.addEventListener('click', () => expandPageContent(el));
            });
        }
        
        async function expandPageContent(el) {
            const taskId = el.dataset.task;
            const pageNum = el.dataset.page;
            const type = el.dataset.type;
            
            if (el.classList.contains('expanded')) {
                el.classList.remove('expanded');
                // æ¢å¤é¢„è§ˆ
                const cache = pageDetailCache.get(`${taskId}-${pageNum}`);
                if (cache) {
                    const text = type === 'ocr' ? cache.ocr_text : cache.translated_text;
                    const preview = text.substring(0, 300);
                    el.textContent = preview + (text.length > 300 ? '...' : '');
                }
                return;
            }
            
            // æ£€æŸ¥ç¼“å­˜
            const cacheKey = `${taskId}-${pageNum}`;
            let detail = pageDetailCache.get(cacheKey);
            
            if (!detail) {
                el.classList.add('loading');
                el.textContent = 'åŠ è½½ä¸­...';
                try {
                    const resp = await fetch(`/tasks/${taskId}/pages/${pageNum}`);
                    if (resp.ok) {
                        detail = await resp.json();
                        pageDetailCache.set(cacheKey, detail);
                    } else {
                        el.textContent = 'åŠ è½½å¤±è´¥';
                        el.classList.remove('loading');
                        return;
                    }
                } catch (e) {
                    el.textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
                    el.classList.remove('loading');
                    return;
                }
                el.classList.remove('loading');
            }
            
            const fullText = type === 'ocr' ? detail.ocr_text : detail.translated_text;
            el.textContent = fullText || 'æ— å†…å®¹';
            el.classList.add('expanded');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderDrawerLogs(logs) {
            if (!logs || logs.length === 0) {
                drawerLogList.innerHTML = '<div style="color:#999;text-align:center;">æš‚æ— æ—¥å¿—</div>';
                return;
            }
            drawerLogList.innerHTML = logs.map(l => 
                `<div class="drawer-log-entry">${new Date(l.ts).toLocaleTimeString()} - ${l.msg}</div>`
            ).join('');
            drawerLogList.scrollTop = drawerLogList.scrollHeight;
        }

        async function handleFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                
                if (!response.ok) {
                    const text = await response.text();
                    alert(text || response.statusText);
                    return;
                }
                
                const data = await response.json();
                currentTaskId = data.task_id;
                
                showProgress(file.name);
                listenProgress(currentTaskId);
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        function showProgress(filename) {
            progressSection.style.display = 'block';
            progressTitle.textContent = filename;
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            ocrProgress.textContent = '0/0';
            translateProgress.textContent = '0/0';
            progressDetail.textContent = '';
            logContent.innerHTML = '';
            status.textContent = '';
            status.className = 'status';
            cancelBtn.style.display = 'block';
            retryBtn.style.display = 'none';
            downloadBtn.style.display = 'none';
            connectAttempt = 0;
            isManuallyClosed = false;
            clearReconnectTimer();
            pageCardsContainer.innerHTML = '';
            drawerLogList.innerHTML = '';
            // è‡ªåŠ¨æ‰“å¼€è¯¦æƒ…æŠ½å±‰
            openDrawer();
        }

        function listenProgress(taskId) {
            clearReconnectTimer();
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            
            currentEventSource = new EventSource(`/progress/${taskId}`);
            
            currentEventSource.onmessage = (e) => {
                const data = JSON.parse(e.data);
                connectAttempt = 0;
                
                progressFill.style.width = data.overall_percent + '%';
                progressPercent.textContent = data.overall_percent + '%';
                progressDetail.textContent = data.message;
                
                if (data.total_pages > 0) {
                    ocrProgress.textContent = `${data.ocr_done}/${data.total_pages}`;
                    translateProgress.textContent = `${data.translate_done}/${data.total_pages}`;
                }
                
                if (data.logs) {
                    logContent.innerHTML = data.logs.map(l => 
                        `<div class="log-entry">${new Date(l.ts).toLocaleTimeString()} - ${l.msg}</div>`
                    ).join('');
                    logContent.scrollTop = logContent.scrollHeight;
                    renderDrawerLogs(data.logs);
                }
                
                if (data.page_summaries) {
                    renderPageSummaries(data.page_summaries);
                }
                
                if (data.status === 'Complete') {
                    isManuallyClosed = true;
                    currentEventSource.close();
                    currentEventSource = null;
                    status.textContent = 'âœ… ' + data.message;
                    status.className = 'status success';
                    cancelBtn.style.display = 'none';
                    retryBtn.style.display = 'none';
                    downloadBtn.style.display = 'block';
                } else if (data.status === 'Error') {
                    isManuallyClosed = true;
                    currentEventSource.close();
                    currentEventSource = null;
                    status.textContent = 'âŒ ' + data.message;
                    status.className = 'status error';
                    cancelBtn.style.display = 'none';
                    // æ˜¾ç¤ºé‡è¯•æŒ‰é’®ï¼ˆé™¤éæ˜¯ä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²å–æ¶ˆï¼‰
                    if (data.message && (data.message.includes('ä¸å­˜åœ¨') || data.message.includes('å·²å–æ¶ˆ'))) {
                        retryBtn.style.display = 'none';
                    } else {
                        retryBtn.style.display = 'block';
                    }
                }
            };
            
            currentEventSource.onerror = () => {
                currentEventSource.close();
                currentEventSource = null;
                
                if (isManuallyClosed) return;
                
                connectAttempt++;
                if (connectAttempt <= MAX_RECONNECT_ATTEMPTS) {
                    const delay = Math.pow(2, connectAttempt - 1) * 1000;
                    status.textContent = `è¿æ¥ä¸­æ–­ï¼Œ${delay / 1000}ç§’åé‡è¯• (${connectAttempt}/${MAX_RECONNECT_ATTEMPTS})...`;
                    status.className = 'status';
                    reconnectTimer = setTimeout(() => {
                        if (!isManuallyClosed) {
                            listenProgress(taskId);
                        }
                    }, delay);
                } else {
                    status.innerHTML = 'è¿æ¥å¤±è´¥ï¼Œ<a href="#" id="retryLink">ç‚¹å‡»é‡è¯•</a>';
                    status.className = 'status error';
                    document.getElementById('retryLink').addEventListener('click', (e) => {
                        e.preventDefault();
                        connectAttempt = 0;
                        listenProgress(taskId);
                    });
                }
            };
        }
    </script>
</body>
</html>
